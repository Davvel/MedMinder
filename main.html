<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a252f">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="icon" type="image/png" sizes="192x192" href="meds_icon_192.png">
    <link rel="apple-touch-icon" href="meds_icon.png">

    <title>MedMinder - Dashboard</title>
    <style>
        :root {
            --primary: #2ecc71; --secondary: #3498db; --header-blue: #1a252f; 
            --danger: #e74c3c; --gray: #95a5a6; --dark-bg: #121212; 
            --card-bg: #1e1e1e; --text-main: #e0e0e0; --text-dim: #b0b0b0; 
            --shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--dark-bg); margin: 0; padding: 0; color: var(--text-main); }
        .top-bar { background: var(--header-blue); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
        .container { max-width: 500px; margin: 0 auto; padding: 10px; }
        header { background: #1a1a1a; padding: 15px; text-align: center; border-bottom: 1px solid #333; margin-bottom: 10px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid #333; }
        h2 { margin-top: 0; color: var(--secondary); font-size: 1.1rem; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 12px; }
        
        .med-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #2a2a2a; }
        .med-item:last-child { border-bottom: none; }
        .med-label-group { display: flex; flex-direction: column; gap: 2px; flex: 1; margin-right: 10px; }
        .med-time-label { font-size: 1.1rem; font-weight: 800; color: #fff; }
        .med-name-label { font-size: 0.95rem; color: var(--text-dim); }

        .btn { border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 700; width: 100%; margin-bottom: 12px; font-size: 0.95rem; transition: all 0.2s ease; display: block; text-align: center; text-decoration: none; }
        .btn-take { background: linear-gradient(135deg, #28a745, #218838); color: white; width: 120px; height: 50px; border-radius: 25px; }
        .btn-nav { background: var(--secondary); color: white; }
        
        .took-container { position: relative; width: 120px; height: 50px; }
        /* Updated btn-took to display vertical content */
        .btn-took { 
            background: #2a2a2a; color: var(--text-dim); width: 100%; height: 100%; 
            border-radius: 25px; border: 1px solid #444; cursor: default; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            margin:0; font-size: 0.85rem; line-height: 1.2;
        }
        .undo-badge { position: absolute; top: -6px; right: -6px; background: var(--danger); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; cursor: pointer; border: 2px solid var(--card-bg); }

        .preview-section { margin-top: 5px; opacity: 0.7; }
        .preview-item { font-size: 0.85rem; padding: 4px 0; border-bottom: 1px dashed #444; display: flex; justify-content: space-between; color: var(--text-dim); }
    </style>
</head>
<body>

<div class="top-bar">
    <strong>MedMinder</strong>
    <span id="version-display"></span>
</div>

<header>
    <h1 id="greeting" style="margin: 0; font-size: 1.3rem;">Hello!</h1>
    <p id="today-display" style="margin: 0; color: var(--text-dim); font-size: 0.85rem;"></p>
</header>

<div class="container">
    <div class="card">
        <h2>Today's Schedule</h2>
        <div id="daily-list"></div>
    </div>

    <div id="tomorrow-preview-card" class="card preview-section">
        <h2 id="tomorrow-header-label" style="font-size: 0.9rem; color: var(--text-dim);">Tomorrow's Preview</h2>
        <div id="tomorrow-list"></div>
    </div>

    <button class="btn btn-nav" onclick="window.location.href='configuremeds.html'">‚öôÔ∏è Configure Medications</button>
    <button class="btn btn-nav" onclick="window.location.href='futuremeds.html'">üìÖ Future Meds (4 Weeks)</button>
    <button class="btn btn-nav" onclick="window.location.href='history.html'">üïí Adherence History</button>
</div>

<script>
    const APP_VERSION = "1.8.4";
    const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    let data = { userName: '', meds: [], history: [], installDate: '' };

    function formatDate(dateObj) {
        const d = new Date(dateObj);
        return `${daysOfWeek[d.getDay()].substring(0,3)} ${String(d.getDate()).padStart(2, '0')}-${months[d.getMonth()]}-${d.getFullYear()}`;
    }

    function formatTillLabel(dateStr, checkDate) {
        if(!dateStr) return "";
        const stop = new Date(dateStr); stop.setHours(0,0,0,0);
        const current = new Date(checkDate); current.setHours(0,0,0,0);
        if (stop.getTime() === current.getTime()) return "(Final Dose)";
        return `(Till ${daysOfWeek[stop.getDay()].substring(0,3)} ${String(stop.getDate()).padStart(2, '0')}-${months[stop.getMonth()]})`;
    }

    function loadData() {
        const saved = localStorage.getItem('medPWA_Data');
        if (saved) { 
            try { 
                data = JSON.parse(saved); 
                if (!Array.isArray(data.meds)) data.meds = [];
                if (!Array.isArray(data.history)) data.history = [];
            } catch(e) {} 
        }
        if (!data.installDate) { 
            const today = new Date(); today.setHours(0,0,0,0);
            data.installDate = today.toDateString();
            saveToDisk();
        }
    }

    function saveToDisk() { localStorage.setItem('medPWA_Data', JSON.stringify(data)); }

    function isExpired(med, checkDate) {
        const dayName = daysOfWeek[checkDate.getDay()];
        const sched = (med.schedules || []).find(s => s.day === dayName);
        if (!sched) return true;
        if (!sched.stopDate) return false;
        const stop = new Date(sched.stopDate); stop.setHours(23,59,59,999);
        return checkDate > stop;
    }

    function renderToday() {
        const list = document.getElementById('daily-list');
        const tomorrowList = document.getElementById('tomorrow-list');
        const now = new Date(); const tomorrow = new Date(); tomorrow.setDate(now.getDate() + 1);
        
        document.getElementById('today-display').innerText = formatDate(now);
        document.getElementById('tomorrow-header-label').innerText = `Tomorrow's Preview (${formatDate(tomorrow).split('-20')[0]})`;

        const daily = data.meds.filter(m => !isExpired(m, now)).sort((a,b) => a.time.localeCompare(b.time));
        const nextDay = data.meds.filter(m => !isExpired(m, tomorrow)).sort((a,b) => a.time.localeCompare(b.time));

        list.innerHTML = daily.length === 0 ? "<p style='text-align:center;'>No meds today.</p>" : 
            daily.map(m => {
                // Find the history record for today to get the timestamp
                const historyEntry = data.history.find(h => h.medId === m.id && h.date === now.toDateString());
                const taken = !!historyEntry;
                const sched = m.schedules.find(s => s.day === daysOfWeek[now.getDay()]);
                const stopLabel = sched && sched.stopDate ? formatTillLabel(sched.stopDate, now) : "";
                
                return `<div class="med-item">
                    <div class="med-label-group">
                        <span class="med-time-label">${m.time}</span>
                        <span class="med-name-label">${m.name}</span>
                        ${stopLabel ? `<span style="font-size:0.7rem; color:var(--danger); font-weight:bold;">${stopLabel}</span>` : ''}
                    </div>
                    <div style="display:flex;align-items:center;">
                        ${taken ? `
                            <div class="took-container">
                                <div class="btn-took">
                                    <div style="font-weight:bold; font-size:0.75rem;">TAKEN</div>
                                    <div style="font-size:0.85rem; color:var(--primary);">${historyEntry.timestamp}</div>
                                </div>
                                <div class="undo-badge" onclick="undoTake('${m.id}')">√ó</div>
                            </div>` : 
                            `<button class="btn btn-take" onclick="takeMed('${m.id}','${m.name}')">TAKING IT</button>`
                        }
                    </div>
                </div>`;
            }).join('');

        tomorrowList.innerHTML = nextDay.length === 0 ? "<p style='font-size:0.8rem;'>None scheduled.</p>" : 
            nextDay.map(m => `<div class="preview-item"><span>${m.name}</span> <span>${m.time}</span></div>`).join('');
    }

    function takeMed(id, name) { 
        data.history.push({
            medId: id, 
            medName: name, 
            date: new Date().toDateString(), 
            // Ensures 24-hour format like 15:37
            timestamp: new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'})
        }); 
        saveToDisk(); renderToday(); 
    }

    function undoTake(id) { 
        if(confirm("Undo?")) { 
            const idx = data.history.findLastIndex(h => h.medId === id && h.date === new Date().toDateString()); 
            if(idx > -1) data.history.splice(idx,1); 
            saveToDisk(); renderToday(); 
        } 
    }

    window.onload = function() {
        loadData();
        document.getElementById('version-display').innerText = "V " + APP_VERSION;
        if (!data.userName) { data.userName = prompt("Enter Name:") || "User"; saveToDisk(); }
        document.getElementById('greeting').innerText = `Hello, ${data.userName}!`;
        renderToday();
    };
</script>
</body>
</html>