<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedMinder</title>
    <style>
        :root {
            --primary: #2ecc71;
            --secondary: #3498db;
            --header-blue: #2980b9;
            --danger: #e74c3c;
            --gray: #95a5a6;
            --dark: #2c3e50;
            --light: #f8f9fa;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light); margin: 0; padding: 0; color: var(--dark); }
        
        .top-bar { 
            background: var(--header-blue); color: white; padding: 10px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100;
        }
        .version-tag { font-size: 0.8em; opacity: 0.9; }

        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        header { background: white; padding: 20px; text-align: center; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .card { background: white; border-radius: 12px; padding: 18px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: var(--header-blue); font-size: 1.4rem; }
        
        .med-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .med-info { flex-grow: 1; }
        .med-time { font-weight: bold; font-size: 1.1em; }
        .stop-tag { font-size: 0.75em; color: var(--danger); display: block; margin-top: 2px; }

        .btn { border: none; padding: 12px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 1rem; }
        .btn-green { background: var(--primary); color: white; width: 100px; }
        .btn-gray { background: var(--gray); color: white; width: 100px; cursor: default; }
        .btn-nav { background: var(--secondary); color: white; width: 100%; margin-bottom: 10px; display: block; text-align: center; text-decoration: none; box-sizing: border-box;}
        .btn-action { padding: 5px 10px; font-size: 0.8em; border-radius: 4px; color: white; margin-left: 5px; }
        .btn-delete { background: var(--danger); }
        .btn-edit { background: var(--secondary); }
        .undo-x { color: var(--danger); font-size: 1.5em; margin-left: 10px; cursor: pointer; vertical-align: middle; }

        .checkbox-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; 
            margin: 10px 0; background: #f1f1f1; padding: 12px; border-radius: 8px;
        }
        .checkbox-item { display: flex; align-items: center; cursor: pointer; font-size: 0.9em; }
        .checkbox-item input { margin-right: 8px; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85em; color: #666; }
        input[type="text"], input[type="time"], input[type="date"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }

        .view { display: none; }
        .view.active { display: block; }
        
        .manager-row { border-bottom: 1px solid #eee; padding: 10px 0; }
        .manager-actions { display: flex; gap: 5px; margin-top: 5px; justify-content: flex-end; }
    </style>
</head>
<body>

<div class="top-bar">
    <strong id="app-title">MedMinder</strong>
    <span class="version-tag" id="version-display"></span>
</div>

<header>
    <h1 id="greeting">Hello!</h1>
    <p id="today-display"></p>
</header>

<div class="container">
    <div id="home-view" class="view active">
        <div class="card">
            <h2>Today's Schedule</h2>
            <div id="daily-list"></div>
        </div>
        <button class="btn btn-nav" onclick="showView('configure-view')">‚öôÔ∏è Configure</button>
        <button class="btn btn-nav" onclick="showView('future-view')">üìÖ Future Meds (4 Weeks)</button>
        <button class="btn btn-nav" onclick="showView('history-view')">üïí 15-Day History</button>
    </div>

    <div id="configure-view" class="view">
        <button class="btn btn-nav" onclick="showView('home-view')">‚Üê Back to Today</button>
        
        <div class="card">
            <h2>User Profile</h2>
            <div class="form-group">
                <label>Your Name:</label>
                <input type="text" id="user-name-input" onchange="updateName(this.value)">
            </div>
        </div>

        <div class="card" id="med-form-card">
            <h2 id="form-title">Add New Medication</h2>
            <input type="hidden" id="edit-id">
            <div class="form-group">
                <label>Medication Name:</label>
                <input type="text" id="med-name" placeholder="e.g. Vitamin C">
            </div>
            <div class="form-group">
                <label>Time to Take:</label>
                <input type="time" id="med-time">
            </div>
            <div class="form-group">
                <label>Stop Taking On (Optional):</label>
                <input type="date" id="med-stop-date">
            </div>
            <label style="font-weight: bold; font-size: 0.85em; color:#666;">Select Days:</label>
            <div class="checkbox-grid" id="day-selector">
                <label class="checkbox-item"><input type="checkbox" value="Monday"> Monday</label>
                <label class="checkbox-item"><input type="checkbox" value="Tuesday"> Tuesday</label>
                <label class="checkbox-item"><input type="checkbox" value="Wednesday"> Wednesday</label>
                <label class="checkbox-item"><input type="checkbox" value="Thursday"> Thursday</label>
                <label class="checkbox-item"><input type="checkbox" value="Friday"> Friday</label>
                <label class="checkbox-item"><input type="checkbox" value="Saturday"> Saturday</label>
                <label class="checkbox-item"><input type="checkbox" value="Sunday"> Sunday</label>
            </div>
            <button class="btn btn-nav" id="save-btn" style="background: var(--primary); margin-top: 10px;" onclick="saveMedication()">Save Medication</button>
            <button class="btn btn-nav" id="cancel-edit-btn" style="background: var(--gray); display:none;" onclick="resetForm()">Cancel Edit</button>
        </div>

        <div id="weekly-overview"></div>
    </div>

    <div id="future-view" class="view">
        <button class="btn btn-nav" onclick="showView('home-view')">‚Üê Back to Today</button>
        <div class="card">
            <h2>Next 4 Weeks</h2>
            <div id="future-list"></div>
        </div>
    </div>

    <div id="history-view" class="view">
        <button class="btn btn-nav" onclick="showView('home-view')">‚Üê Back to Today</button>
        <div class="card">
            <h2>Recent History</h2>
            <div id="history-list"></div>
        </div>
    </div>
</div>

<script>
    // --- Version Control ---
    const APP_VERSION = "1.2.0";

    let data = JSON.parse(localStorage.getItem('medPWA_Data')) || {
        userName: '',
        meds: [],
        history: []
    };

    const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

    function init() {
        document.getElementById('version-display').innerText = "V " + APP_VERSION;
        if (!data.userName) {
            data.userName = prompt("Welcome! Please enter your name:") || "User";
            save();
        }
        document.getElementById('user-name-input').value = data.userName;
        updateGreeting();
        const now = new Date();
        document.getElementById('today-display').innerText = now.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
        renderToday();
    }

    function save() { localStorage.setItem('medPWA_Data', JSON.stringify(data)); }

    function updateGreeting() { document.getElementById('greeting').innerText = `Hello, ${data.userName}!`; }

    function updateName(newName) {
        if (newName.trim()) { data.userName = newName; save(); updateGreeting(); }
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        if(viewId === 'home-view') renderToday();
        if(viewId === 'configure-view') renderWeeklyCalendar();
        if(viewId === 'history-view') renderHistory();
        if(viewId === 'future-view') renderFuture();
        window.scrollTo(0,0);
    }

    // --- Logic ---
    function saveMedication() {
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('med-name').value;
        const time = document.getElementById('med-time').value;
        const stopDate = document.getElementById('med-stop-date').value;
        const selectedDays = Array.from(document.querySelectorAll('#day-selector input:checked')).map(cb => cb.value);

        if (!name || !time || selectedDays.length === 0) {
            alert("Please fill in name, time, and at least one day.");
            return;
        }

        if (id) {
            // Update existing
            const index = data.meds.findIndex(m => m.id === id);
            data.meds[index] = { id, name, time, stopDate, days: selectedDays };
        } else {
            // Add new
            data.meds.push({ id: Date.now().toString(), name, time, stopDate, days: selectedDays });
        }

        save();
        resetForm();
        renderWeeklyCalendar();
    }

    function editMed(id) {
        const med = data.meds.find(m => m.id === id);
        if (!med) return;

        document.getElementById('form-title').innerText = "Edit Medication";
        document.getElementById('edit-id').value = med.id;
        document.getElementById('med-name').value = med.name;
        document.getElementById('med-time').value = med.time;
        document.getElementById('med-stop-date').value = med.stopDate || '';
        
        document.querySelectorAll('#day-selector input').forEach(cb => {
            cb.checked = med.days.includes(cb.value);
        });

        document.getElementById('cancel-edit-btn').style.display = 'block';
        window.scrollTo(0, document.getElementById('med-form-card').offsetTop - 60);
    }

    function resetForm() {
        document.getElementById('form-title').innerText = "Add New Medication";
        document.getElementById('edit-id').value = '';
        document.getElementById('med-name').value = '';
        document.getElementById('med-time').value = '';
        document.getElementById('med-stop-date').value = '';
        document.querySelectorAll('#day-selector input').forEach(cb => cb.checked = false);
        document.getElementById('cancel-edit-btn').style.display = 'none';
    }

    function deleteMed(id) {
        if(confirm("Remove this medication entirely?")) {
            data.meds = data.meds.filter(m => m.id !== id);
            save();
            renderWeeklyCalendar();
        }
    }

    function isExpired(med, dateObj) {
        if (!med.stopDate) return false;
        const stop = new Date(med.stopDate);
        stop.setHours(23, 59, 59, 999);
        return dateObj > stop;
    }

    // --- Rendering ---
    function renderToday() {
        const list = document.getElementById('daily-list');
        const now = new Date();
        const todayName = daysOfWeek[now.getDay()];
        const todayStr = now.toDateString();
        
        const todaysMeds = data.meds
            .filter(m => m.days.includes(todayName) && !isExpired(m, now))
            .sort((a, b) => a.time.localeCompare(b.time));

        list.innerHTML = todaysMeds.length === 0 ? "<p style='text-align:center; color:gray;'>No medications for today.</p>" :
            todaysMeds.map(med => {
                const taken = data.history.some(h => h.medId === med.id && h.date === todayStr);
                return `
                    <div class="med-item">
                        <div class="med-info">
                            <div class="med-time">${med.time}</div>
                            <div class="med-name">${med.name}</div>
                            ${med.stopDate ? `<span class="stop-tag">Ends: ${med.stopDate}</span>` : ''}
                        </div>
                        <div>
                            ${taken ? 
                                `<button class="btn btn-gray">TOOK IT</button><span class="undo-x" onclick="undoTake('${med.id}')">√ó</span>` : 
                                `<button class="btn btn-green" onclick="takeMed('${med.id}', '${med.name}')">TAKING IT</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
    }

    function renderWeeklyCalendar() {
        const container = document.getElementById('weekly-overview');
        container.innerHTML = "<h3>Medication Manager</h3>";
        daysOfWeek.forEach(day => {
            const dayMeds = data.meds.filter(m => m.days.includes(day)).sort((a, b) => a.time.localeCompare(b.time));
            let dayHtml = `<div class="card"><h4>${day}</h4>`;
            dayHtml += dayMeds.length === 0 ? `<p style="color:gray; font-size:0.8em;">No meds</p>` : 
                dayMeds.map(m => `
                    <div class="manager-row">
                        <div style="font-size:0.9em;"><strong>${m.time}</strong> ${m.name}</div>
                        ${m.stopDate ? `<div class="stop-tag">Stop Date: ${m.stopDate}</div>` : ''}
                        <div class="manager-actions">
                            <button class="btn btn-action btn-edit" onclick="editMed('${m.id}')">Edit</button>
                            <button class="btn btn-action btn-delete" onclick="deleteMed('${m.id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            dayHtml += `</div>`;
            container.innerHTML += dayHtml;
        });
    }

    function renderFuture() {
        const list = document.getElementById('future-list');
        list.innerHTML = "";
        const now = new Date();
        for (let i = 0; i < 28; i++) {
            let futureDate = new Date();
            futureDate.setDate(now.getDate() + i);
            const dayName = daysOfWeek[futureDate.getDay()];
            const dayMeds = data.meds.filter(m => m.days.includes(dayName) && !isExpired(m, futureDate)).sort((a, b) => a.time.localeCompare(b.time));
            if (dayMeds.length > 0) {
                let daySection = `<div class="future-day-bucket"><span class="future-date-label">${futureDate.toDateString()}</span>`;
                daySection += dayMeds.map(m => `<div style="font-size:0.9em; padding:2px 0;">${m.time} - ${m.name}</div>`).join('');
                daySection += `</div>`;
                list.innerHTML += daySection;
            }
        }
    }

    function takeMed(id, name) {
        data.history.push({ medId: id, medName: name, date: new Date().toDateString(), timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
        save(); renderToday();
    }

    function undoTake(id) {
        if (confirm("Are you sure you did NOT take this medicine?")) {
            const index = data.history.findLastIndex(h => h.medId === id && h.date === new Date().toDateString());
            if (index > -1) { data.history.splice(index, 1); save(); renderToday(); }
        }
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - 15);
        const filtered = data.history.filter(h => new Date(h.date) >= cutoff).reverse();
        list.innerHTML = filtered.length === 0 ? "<p>No history.</p>" : 
            filtered.map(h => `<div class="med-item"><div class="med-info"><small>${h.date}</small><div><strong>${h.medName}</strong></div></div><div style="color:var(--secondary); font-weight:bold;">${h.timestamp}</div></div>`).join('');
    }

    init();
</script>
</body>
</html>