<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedMinder - Future Schedule</title>
    <style>
        :root {
            --primary: #2ecc71; --secondary: #3498db; --header-blue: #1a252f; 
            --danger: #e74c3c; --gray: #95a5a6; --dark-bg: #121212; --card-bg: #1e1e1e; 
            --text-main: #e0e0e0; --text-dim: #b0b0b0; --shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--dark-bg); margin: 0; padding: 0; color: var(--text-main); }
        .top-bar { background: var(--header-blue); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
        .container { max-width: 500px; margin: 0 auto; padding: 10px; }
        .btn { border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 700; width: 100%; margin-bottom: 15px; font-size: 0.95rem; transition: all 0.2s ease; display: block; text-align: center; background: var(--secondary); color: white; }
        
        /* Projection Styling */
        .month-header { background: #333; color: white; padding: 10px; border-radius: 8px; margin: 20px 0 10px 0; text-align: center; font-weight: bold; font-size: 1rem; }
        .week-chunk { border-left: 4px solid var(--secondary); background: #252525; padding: 12px; border-radius: 0 10px 10px 0; margin-bottom: 15px; box-shadow: var(--shadow); }
        .week-title { font-size: 0.8rem; color: var(--secondary); font-weight: 800; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .day-block { margin-bottom: 12px; }
        .day-label { font-weight: bold; font-size: 0.9rem; margin-bottom: 4px; color: #fff; }
        .med-row { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 2px; }
    </style>
</head>
<body>

<div class="top-bar">
    <strong>MedMinder Projection</strong>
</div>

<div class="container">
    <button class="btn" onclick="window.history.back()">‚Üê Back</button>
    <div id="future-list-content"></div>
</div>

<script>
    const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const fullMonths = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    let data = JSON.parse(localStorage.getItem('medPWA_Data')) || { meds: [] };

    function formatDate(dateObj) {
        const d = new Date(dateObj);
        return `${daysOfWeek[d.getDay()].substring(0,3)} ${String(d.getDate()).padStart(2, '0')}-${months[d.getMonth()]}-${d.getFullYear()}`;
    }

    function formatTillLabel(dateStr, checkDate) {
        if(!dateStr) return "";
        const stop = new Date(dateStr); stop.setHours(0,0,0,0);
        const current = new Date(checkDate); current.setHours(0,0,0,0);
        if (stop.getTime() === current.getTime()) return "(Final Dose)";
        return `(Till ${daysOfWeek[stop.getDay()].substring(0,3)} ${String(stop.getDate()).padStart(2, '0')}-${months[stop.getMonth()]})`;
    }

    function isExpired(med, checkDate) {
        const dayName = daysOfWeek[checkDate.getDay()];
        const sched = (med.schedules || []).find(s => s.day === dayName);
        if (!sched) return true;
        if (!sched.stopDate) return false;
        const stop = new Date(sched.stopDate); 
        stop.setHours(23, 59, 59, 999);
        return checkDate > stop;
    }

    function renderFuture() {
        const list = document.getElementById('future-list-content');
        list.innerHTML = "";
        const now = new Date();
        let currentMonth = -1;
        let weekContainer = null;

        // Projection for 28 days starting from Tomorrow
        for (let i = 1; i <= 28; i++) {
            let d = new Date();
            d.setDate(now.getDate() + i);
            d.setHours(0,0,0,0);
            
            const medsForDay = data.meds.filter(m => !isExpired(m, d)).sort((a,b) => a.time.localeCompare(b.time));

            // Month Header Logic
            if (d.getMonth() !== currentMonth) {
                currentMonth = d.getMonth();
                const mHead = document.createElement('div');
                mHead.className = "month-header";
                mHead.innerText = `${fullMonths[currentMonth]} ${d.getFullYear()}`;
                list.appendChild(mHead);
            }

            // Weekly Chunk Logic (Starts Monday)
            if (d.getDay() === 1 || !weekContainer) {
                weekContainer = document.createElement('div');
                weekContainer.className = "week-chunk";
                const wTitle = document.createElement('div');
                wTitle.className = "week-title";
                wTitle.innerText = `Week starting ${formatDate(d)}`;
                weekContainer.appendChild(wTitle);
                list.appendChild(weekContainer);
            }

            if (medsForDay.length > 0) {
                const dayDiv = document.createElement('div');
                dayDiv.className = "day-block";
                
                let dayHtml = `<div class="day-label">${formatDate(d)}</div>`;
                medsForDay.forEach(m => {
                    const sched = m.schedules.find(s => s.day === daysOfWeek[d.getDay()]);
                    const stopLabel = (sched && sched.stopDate) ? `<span style="color:var(--danger); font-weight:bold;"> ${formatTillLabel(sched.stopDate, d)}</span>` : "";
                    dayHtml += `<div class="med-row"><strong>${m.time}</strong> - ${m.name}${stopLabel}</div>`;
                });
                
                dayDiv.innerHTML = dayHtml;
                weekContainer.appendChild(dayDiv);
            }
        }
        if (list.innerHTML === "") list.innerHTML = "<p style='text-align:center;'>No upcoming medications scheduled.</p>";
    }

    window.onload = renderFuture;
</script>
</body>
</html>